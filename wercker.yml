# Copyright 2017, 2018, Oracle Corporation and/or its affiliates.  All rights reserved.
# Licensed under the Universal Permissive License v 1.0 as shown at http://oss.oracle.com/licenses/upl.

#
#  Wercker build file for Oracle WebLogic Server Kubernetes Operator
#

#
#  Wercker application is at : https://app.wercker.com/Oracle/weblogic-kubernetes-operator
#
#  Werkcer workflow looks like this:
#
#  build -> integration-tests (1.7.9)
#        -> integration-tests (1.8.5)
#        -> quality
#

box: maven:3.5.2-jdk-8

# This is the main build pipeline that builds the codebase and runs unit tests.
build:
  steps:
  - install-packages:
    packages: jq gpg gnupg gnupg2

  - script:
    name: Fetch SSCM Dependencies
    code: |
      echo "Fetching SSCM Dependencies ..."
      echo "type gpg && gpg --version"
      type gpg && gpg --version
      echo "type gpg2 && gpg2 --version"
      type gpg2 && gpg2 --version
      echo "mkdir $SSCM_BUILD_DIR"
      mkdir $SSCM_BUILD_DIR
      echo "cd $SSCM_BUILD_DIR"
      cd $SSCM_BUILD_DIR
      echo "git clone https://github.com/wmhopkins/client-java.git"
      git clone https://github.com/wmhopkins/client-java.git
      echo "git clone https://github.com/wmhopkins/sscm-client.git"
      git clone https://github.com/wmhopkins/sscm-client.git
      echo "cp -f $SSCM_BUILD_DIR/sscm-client/gnupg/gpg-script.sh $WERCKER_CACHE_DIR"
      cp -f $SSCM_BUILD_DIR/sscm-client/gnupg/gpg-script.sh $WERCKER_CACHE_DIR
      echo "chmod +x $WERCKER_CACHE_DIR/gpg-script.sh"
      chmod +x $WERCKER_CACHE_DIR/gpg-script.sh
      echo "ls -l $WERCKER_CACHE_DIR/gpg-script.sh"
      ls -l $WERCKER_CACHE_DIR/gpg-script.sh
      echo "GPG_SCRIPT env variable set to: '$GPG_SCRIPT'"
      echo "$GPG_SCRIPT data-to-sign"
      echo "ls -l $WERCKER_CACHE_DIR/gnupg"
      ls -l $WERCKER_CACHE_DIR/gnupg
      $GPG_SCRIPT data-to-sign
      echo "ls -l $WERCKER_CACHE_DIR/gnupg"
      ls -l $WERCKER_CACHE_DIR/gnupg

  - script:
    name: Build Java Client
    code: |
      echo "Building Java Client ..."
      echo "cd $SSCM_BUILD_DIR/client-java"
      cd $SSCM_BUILD_DIR/client-java
      echo "mvn -Dmaven.repo.local=$WERCKER_CACHE_DIR/.m2 clean install"
      mvn -Dmaven.repo.local=$WERCKER_CACHE_DIR/.m2 clean install

  - script:
    name: Build SSCM Plugins
    code: |
      echo "Building SSCM Plugins ..."
      echo "cd $SSCM_BUILD_DIR/sscm-client"
      cd $SSCM_BUILD_DIR/sscm-client
      echo "mvn -Dmaven.repo.local=$WERCKER_CACHE_DIR/.m2 clean install"
      mvn -Dmaven.repo.local=$WERCKER_CACHE_DIR/.m2 clean install

  - script:
    name: Hello
    code: |
      echo "Building Oracle WebLogic Server Kubernetes Operator..."
      echo "The branch and commit id are $WERCKER_GIT_BRANCH, $WERCKER_GIT_COMMIT"
  - install-packages:
      packages: tar gzip
  - java/maven:
      goals: clean install
      version: 3.5.2
      cache_repo: true
  - script:
      name: Copy built-artifacts into the image
      code: |
        mkdir /operator
        cp -R src/main/scripts/* /operator/
        cp target/weblogic-kubernetes-operator-0.1.0.jar /operator/weblogic-kubernetes-operator.jar
        export IMAGE_TAG_OPERATOR="${WERCKER_GIT_BRANCH//[_\/]/-}"
        if [ "$IMAGE_TAG_OPERATOR" = "master" ]; then
          export IMAGE_TAG_OPERATOR="latest"
        fi

test:
  steps:
  - script:
    name: Test
    code: |
      echo "Test Step"

security-scan:
  steps:
  - script:
    name: Security Scan
    code: |
      echo "Security Scan Step"

deploy-with-atz:
  steps:
  - install-packages:
      packages: jq

  - script:
    name: Deploy with ATZ
    code: |
      echo "Deploy with ATZ"

dev:
  steps:
  - internal/shell

